<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¶”ì–µì˜ ìƒì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background:#f5f7fb; margin:0; padding:20px; }
    .container { max-width: 900px; margin:auto; }

    h1 { text-align:center; margin-bottom: 10px; }
    
    h2, h3 { margin-top: 0; }

    .btn {
      padding:10px 18px; border:none; border-radius:30px; cursor:pointer;
      font-weight:600; font-size:14px; color:white; background:#4b6bff;
      margin:4px; box-shadow:0 3px 8px rgba(75,107,255,0.35);
    }
    .btn.secondary { background:#e2e6ff; color:#1c266b; box-shadow:none; }
    .btn.danger { background:#ff4b6b; }

    .card {
      background:white; padding:20px; border-radius:14px;
      margin-bottom:20px; box-shadow:0 5px 16px rgba(0,0,0,0.08);
    }

    .hidden { display:none; }

    input, select {
      padding:7px 10px; border:1px solid #cfd4df; border-radius:8px; width:100%;
      font-size:14px;
    }

    .question-box { margin-bottom:14px; }
    .question-box label { font-weight:600; display:block; margin-bottom:6px; }

    .rank-label { font-size:13px; margin-top:4px; margin-bottom:2px; display:block; }

    #resultBox {
      white-space:pre-wrap;
      background:#0f172a;
      color:#e5e7eb;
      padding:12px;
      border-radius:10px;
      font-size:13px;
      max-height:400px;
      overflow-y:auto;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>

<body>
<div class="container">
  <h1>ì¶”ì–µì˜ ìƒì</h1>

  <div id="modeSelect" class="card" style="text-align:center;">
    <p>ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <button class="btn" onclick="showParticipant()">ì°¸ì—¬ì ëª¨ë“œ</button>
    <button class="btn secondary" onclick="showAdminLogin()">ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <div id="adminLogin" class="card hidden">
    <h3>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="adminPW" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button class="btn" onclick="checkAdmin()">í™•ì¸</button>
    <button class="btn secondary" onclick="backToMode()">ë’¤ë¡œê°€ê¸°</button>
  </div>

  <div id="participant" class="card hidden">
    <h2>ì¹œêµ¬ë“¤ì„ ë– ì˜¬ë¦¬ë©° ì„ íƒí•´ì£¼ì„¸ìš” (TOP2)</h2>
    <p style="font-size:13px; color:#4b5563;">
      1ìœ„ëŠ” 2ì , 2ìœ„ëŠ” 1ì ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
      ì´ë¦„ì€ ê°€ëŠ¥í•œ í•œ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì ì–´ ì£¼ì„¸ìš”.
    </p>

    <div id="questions"></div>

    <button class="btn" onclick="submitVotes()">ì œì¶œí•˜ê¸°</button>
    <button class="btn secondary" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <div id="adminPanel" class="card hidden">
    <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
    <p><b>ì´ ì œì¶œ ì¸ì›:</b> <span id="totalVotes">0</span> ëª…</p>

    <button class="btn secondary" onclick="showAdmin()">ìƒˆë¡œê³ ì¹¨</button>
    <button class="btn danger" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
    <button class="btn" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>

    <div class="card" style="margin-top:15px;">
      <h3>ì§ˆë¬¸ë³„ ê²°ê³¼ ë³´ê¸°</h3>
      <select id="graphSelect"></select>
      <button class="btn secondary" onclick="showQuestionResult()">ì„ íƒí•œ ì§ˆë¬¸ ê²°ê³¼ ë³´ê¸°</button>
    </div>

    <div class="card">
      <h3>ì „ì²´ í•©ì‚° ê²°ê³¼</h3>
      <button class="btn secondary" onclick="showTotal()">ì „ì²´ í•©ì‚° ì ìˆ˜ ë³´ê¸°</button>
    </div>

    <h3>ê²°ê³¼ ì¶œë ¥</h3>
    <div id="resultBox">ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
/* --------------------------
   ì„¤ì • (4ë°˜ Firebase + PW)
-------------------------- */

const PASSWORD = "qodmsgkrtjstodslatkfkdgkqslek";

const firebaseConfig = {
  apiKey: "AIzaSyAqCEZSEcj6Dpgc5JvXk7DRoj6hvNo_ZKg",
  authDomain: "memory-4-8ecb2.firebaseapp.com",
  databaseURL: "https://memory-4-8ecb2-default-rtdb.firebaseio.com",
  projectId: "memory-4-8ecb2",
  storageBucket: "memory-4-8ecb2.firebasestorage.app",
  messagingSenderId: "863511480546",
  appId: "1:863511480546:web:82ccf750d41ead911e36bb",
  measurementId: "G-7LP0HHDGG7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* --------------------------
   ì§ˆë¬¸ ëª©ë¡
-------------------------- */
const QUESTIONS = [
  "ì²­ì†Œë¥¼ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
  "ë„ì›€ì´ í•„ìš”í•  ë•Œ ê¸°ëŒˆ ìˆ˜ ìˆì—ˆë˜ ì¹œêµ¬",
  "í•™êµ í–‰ì‚¬, ì¼ì • ë“± ì „ë‹¬ ì‚¬í•­ì„ ì˜ ê³µì§€í•´ì£¼ë˜ ì¹œêµ¬",
  "ìˆ˜ì—… ë¶„ìœ„ê¸° ì¡°ì„±ì„ ì˜ ë§ì¶°ì£¼ë˜ ì¹œêµ¬",
  "í˜ë“¤ ë•Œ ì›ƒì„ ìˆ˜ ìˆê²Œ í•´ì£¼ë˜ ì¹œêµ¬",
  "í•™êµ í–‰ì‚¬ì— ì—´ì‹¬íˆ ì°¸ì—¬í•˜ë˜ ì¹œêµ¬",
  "ë¦¬ë”ì‹­, ì¹´ë¦¬ìŠ¤ë§ˆê°€ ë„˜ì¹˜ë˜ ì¹œêµ¬",
  "ë´‰ì‚¬í™œë™ì„ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
  "ì‚¬ì†Œí•œ ì¼ì—ë„ ì•½ì†ì„ ì˜ ì§€í‚¤ë˜ ì¹œêµ¬",
  "ë°”ë¥¸ì–¸ì–´, ë°”ë¥¸ í–‰ë™ ë“± í’ˆì„±ì´ ì•„ë¦„ë‹µë˜ ì¹œêµ¬"
];

/* --------------------------
   í™”ë©´ ì œì–´
-------------------------- */
function hideAll() {
  ["modeSelect", "adminLogin", "participant", "adminPanel"]
    .forEach(id => document.getElementById(id).classList.add("hidden"));
}

function backToMode() {
  hideAll();
  document.getElementById("modeSelect").classList.remove("hidden");
}

/* --------------------------
   ì°¸ì—¬ì ëª¨ë“œ
-------------------------- */
function showParticipant() {
  if (localStorage.getItem("submitted_4ban") === "yes") {
    alert("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ íˆ¬í‘œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤!");
    return;
  }
  hideAll();
  document.getElementById("participant").classList.remove("hidden");
  buildQuestionForm();
}

function buildQuestionForm() {
  const box = document.getElementById("questions");
  box.innerHTML = "";

  QUESTIONS.forEach((q, i) => {
    box.innerHTML += `
      <div class="question-box">
        <label>${i + 1}. ${q}</label>
        <span class="rank-label">1ìœ„ (2ì )</span>
        <input id="q${i}_1">
        <span class="rank-label">2ìœ„ (1ì )</span>
        <input id="q${i}_2">
      </div>
    `;
  });
}

/* --------------------------
   ì´ë¦„ ìë™ í†µí•© ê¸°ëŠ¥ (í•µì‹¬)
-------------------------- */
function normalizeName(name, existingNames) {
  if (!name) return "";

  // ê¸°ë³¸ ì •ë¦¬
  name = name.trim().replace(/\s+/g, "").replace(/(ì´|ì•¼|ë‹˜|êµ°|ì–‘|ì”¨|ìš”)$/g, "");

  // ê¸°ì¡´ ì´ë¦„ë“¤ê³¼ 'ë¶€ë¶„ ë¬¸ìì—´ ì¼ì¹˜' ë¹„êµ
  for (let saved of existingNames) {
    if (!saved) continue;

    // ğŸ”¥ í•µì‹¬ ê·œì¹™
    if (saved.includes(name) || name.includes(saved)) {
      return saved;
    }
  }

  return name;
}

/* --------------------------
   íˆ¬í‘œ ì œì¶œ
-------------------------- */
async function submitVotes() {
  if (localStorage.getItem("submitted_4ban") === "yes") {
    alert("ì´ë¯¸ ì œì¶œí–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  // ê¸°ì¡´ DB ë°ì´í„° ìˆ˜ì§‘
  const snap = await db.ref("/4ban/votes").get();
  let existingNames = new Set();

  snap.forEach(child => {
    child.val().forEach(ans => {
      if (ans.first) existingNames.add(ans.first);
      if (ans.second) existingNames.add(ans.second);
    });
  });

  let voteData = [];

  QUESTIONS.forEach((_, i) => {
    let firstRaw = document.getElementById(`q${i}_1`).value;
    let secondRaw = document.getElementById(`q${i}_2`).value;

    let first = normalizeName(firstRaw, existingNames);
    let second = normalizeName(secondRaw, existingNames);

    if (first) existingNames.add(first);
    if (second) existingNames.add(second);

    if (first && second && first === second) second = "";

    voteData.push({ first, second });
  });

  // ì €ì¥
  await db.ref("/4ban/votes").push(voteData);

  // ì¹´ìš´íŠ¸ ì¦ê°€
  db.ref("/4ban/voteCount").transaction(x => (x || 0) + 1);

  localStorage.setItem("submitted_4ban", "yes");

  alert("ì œì¶œ ì™„ë£Œ!");
  backToMode();
}

/* --------------------------
   ê´€ë¦¬ì ë¡œê·¸ì¸
-------------------------- */
function showAdminLogin() {
  hideAll();
  document.getElementById("adminLogin").classList.remove("hidden");
}

function checkAdmin() {
  if (document.getElementById("adminPW").value === PASSWORD) showAdmin();
  else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
}

/* --------------------------
   ê´€ë¦¬ì íŒ¨ë„
-------------------------- */
async function showAdmin() {
  hideAll();
  document.getElementById("adminPanel").classList.remove("hidden");

  const count = await db.ref("/4ban/voteCount").get();
  document.getElementById("totalVotes").innerText = count.val() || 0;

  const sel = document.getElementById("graphSelect");
  sel.innerHTML = "";
  QUESTIONS.forEach((q, i) =>
    sel.innerHTML += `<option value="${i}">${i + 1}. ${q}</option>`
  );

  document.getElementById("resultBox").innerText = "ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.";
}

/* --------------------------
   ì§ˆë¬¸ë³„ ê²°ê³¼
-------------------------- */
async function showQuestionResult() {
  const idx = Number(document.getElementById("graphSelect").value);
  const snap = await db.ref("/4ban/votes").get();

  let score = {};

  snap.forEach(child => {
    const ans = child.val()[idx];
    if (ans.first) score[ans.first] = (score[ans.first] || 0) + 2;
    if (ans.second) score[ans.second] = (score[ans.second] || 0) + 1;
  });

  let text = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\n`;
  const sorted = Object.entries(score).sort((a, b) => b[1] - a[1]);

  if (sorted.length === 0) text += "ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  else sorted.forEach(([name, sc], i) => text += `${i + 1}ìœ„. ${name} : ${sc}ì \n`);

  document.getElementById("resultBox").innerText = text;
}

/* --------------------------
   ì „ì²´ í•©ì‚°
-------------------------- */
async function showTotal() {
  const snap = await db.ref("/4ban/votes").get();

  let total = {};

  snap.forEach(child => {
    child.val().forEach(ans => {
      if (ans.first) total[ans.first] = (total[ans.first] || 0) + 2;
      if (ans.second) total[ans.second] = (total[ans.second] || 0) + 1;
    });
  });

  let text = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\n";
  const sorted = Object.entries(total).sort((a, b) => b[1] - a[1]);

  if (sorted.length === 0) text += "ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  else sorted.forEach(([name, sc], i) => text += `${i + 1}ìœ„. ${name} : ${sc}ì \n`);

  document.getElementById("resultBox").innerText = text;
}

/* --------------------------
   ë°ì´í„° ì´ˆê¸°í™” (+ íˆ¬í‘œ ì´ˆê¸°í™”)
-------------------------- */
async function resetAll() {
  if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  await db.ref("/4ban").remove();

  // ğŸ”¥ íˆ¬í‘œ ì¬ê°€ëŠ¥í•˜ê²Œ ë§Œë“¦
  localStorage.removeItem("submitted_4ban");

  alert("ëª¨ë“  ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
  showAdmin();
}
</script>

</body>
</html>

