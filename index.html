<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¶”ì–µì˜ ìƒì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background:#f5f7fb; margin:0; padding:20px; }
    .container { max-width: 900px; margin:auto; }

    h1 { text-align:center; margin-bottom: 10px; }
    h2, h3 { margin-top: 0; }

    .btn {
      padding:10px 18px; border:none; border-radius:30px; cursor:pointer;
      font-weight:600; font-size:14px; color:white; background:#4b6bff;
      margin:4px; box-shadow:0 3px 8px rgba(75,107,255,0.35);
    }
    .btn.secondary { background:#e2e6ff; color:#1c266b; box-shadow:none; }
    .btn.danger { background:#ff4b6b; }

    .card {
      background:white; padding:20px; border-radius:14px;
      margin-bottom:20px; box-shadow:0 5px 16px rgba(0,0,0,0.08);
    }

    .hidden { display:none; }

    input, select {
      padding:7px 10px; border:1px solid #cfd4df; border-radius:8px; width:100%;
      font-size:14px;
    }

    .question-box { margin-bottom:14px; }
    .question-box label { font-weight:600; display:block; margin-bottom:6px; }

    .rank-label { font-size:13px; margin-top:4px; margin-bottom:2px; display:block; }

    #resultBox {
      white-space:pre-wrap;
      background:#0f172a;
      color:#e5e7eb;
      padding:12px;
      border-radius:10px;
      font-size:13px;
      max-height:400px;
      overflow-y:auto;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ì¶”ì–µì˜ ìƒì</h1>

  <!-- ëª¨ë“œ ì„ íƒ -->
  <div id="modeSelect" class="card" style="text-align:center;">
    <p>ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <button class="btn" onclick="showParticipant()">ì°¸ì—¬ì ëª¨ë“œ</button>
    <button class="btn secondary" onclick="showAdminLogin()">ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
  <div id="adminLogin" class="card hidden">
    <h3>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="adminPW" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button class="btn" onclick="checkAdmin()">í™•ì¸</button>
    <button class="btn secondary" onclick="backToMode()">ë’¤ë¡œê°€ê¸°</button>
  </div>

  <!-- ì°¸ì—¬ì í™”ë©´ -->
  <div id="participant" class="card hidden">
    <h2>ì¹œêµ¬ë“¤ì„ ë– ì˜¬ë¦¬ë©° ì„ íƒí•´ì£¼ì„¸ìš” (TOP2)</h2>
    <p style="font-size:13px; color:#4b5563;">
      1ìœ„ëŠ” 2ì , 2ìœ„ëŠ” 1ì ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
      ì´ë¦„ì€ ê°€ëŠ¥í•œ í•œ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì ì–´ ì£¼ì„¸ìš”. (ì˜ˆ: "ì´ì§€í›ˆ" ë˜ëŠ” "ì§€í›ˆ" ì¤‘ í•˜ë‚˜ë¡œ í†µì¼)
    </p>

    <div id="questions"></div>

    <button class="btn" onclick="submitVotes()">ì œì¶œí•˜ê¸°</button>
    <button class="btn secondary" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminPanel" class="card hidden">
    <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
    <p style="font-size:14px;">
      <b>ì´ ì œì¶œ ì¸ì›:</b> <span id="totalVotes">0</span> ëª…
    </p>
    <div style="margin-bottom:10px;">
      <button class="btn secondary" onclick="showAdmin()">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn danger" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="btn" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì§ˆë¬¸ë³„ ê²°ê³¼ ë³´ê¸°</h3>
      <select id="graphSelect" style="margin-bottom:8px;"></select>
      <button class="btn secondary" onclick="showQuestionResult()">ì„ íƒí•œ ì§ˆë¬¸ ê²°ê³¼ ë³´ê¸°</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì „ì²´ í•©ì‚° ê²°ê³¼</h3>
      <button class="btn secondary" onclick="showTotal()">ì „ì²´ í•©ì‚° ì ìˆ˜ ë³´ê¸°</button>
    </div>

    <h3>ê²°ê³¼ ì¶œë ¥</h3>
    <div id="resultBox">ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script type="module">
  /* --------------------------
        Firebase ì´ˆê¸°í™”
  --------------------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, get, set, update } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAqCEZSEcj6Dpgc5JvXk7DRoj6hvNo_ZKg",
    authDomain: "memory-4-8ecb2.firebaseapp.com",
    databaseURL: "https://memory-4-8ecb2-default-rtdb.firebaseio.com",
    projectId: "memory-4-8ecb2",
    storageBucket: "memory-4-8ecb2.firebasestorage.app",
    messagingSenderId: "863511480546",
    appId: "1:863511480546:web:82ccf750d41ead911e36bb",
    measurementId: "G-7LP0HHDGG7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* --------------------------
          ì„¤ì •ê°’
  --------------------------- */
  const QUESTIONS = [
    "ì²­ì†Œë¥¼ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ë„ì›€ì´ í•„ìš”í•  ë•Œ ê¸°ëŒˆ ìˆ˜ ìˆì—ˆë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬, ì¼ì • ë“± ì „ë‹¬ ì‚¬í•­ì„ ì˜ ê³µì§€í•´ì£¼ë˜ ì¹œêµ¬",
    "ìˆ˜ì—… ë¶„ìœ„ê¸° ì¡°ì„±ì„ ì˜ ë§ì¶°ì£¼ë˜ ì¹œêµ¬",
    "í˜ë“¤ ë•Œ ì›ƒì„ ìˆ˜ ìˆê²Œ í•´ì£¼ë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬ì— ì—´ì‹¬íˆ ì°¸ì—¬í•˜ë˜ ì¹œêµ¬",
    "ë¦¬ë”ì‹­, ì¹´ë¦¬ìŠ¤ë§ˆê°€ ë„˜ì¹˜ë˜ ì¹œêµ¬",
    "ë´‰ì‚¬í™œë™ì„ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ì‚¬ì†Œí•œ ì¼ì—ë„ ì•½ì†ì„ ì˜ ì§€í‚¤ë˜ ì¹œêµ¬",
    "ë°”ë¥¸ì–¸ì–´, ë°”ë¥¸ í–‰ë™ ë“± í’ˆì„±ì´ ì•„ë¦„ë‹µë˜ ì¹œêµ¬"
  ];

  const PASSWORD = "qodmsgkrtjstodslatkfkdgkqslek";

  /* --------------------------
          ê³µí†µ UI í•¨ìˆ˜
  --------------------------- */
  function hideAll() {
    document.getElementById("modeSelect").classList.add("hidden");
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("participant").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  function backToMode() {
    hideAll();
    document.getElementById("modeSelect").classList.remove("hidden");
  }

  /* --------------------------
        ì°¸ì—¬ì ëª¨ë“œ
  --------------------------- */
  function showParticipant() {
    hideAll();
    document.getElementById("participant").classList.remove("hidden");
    buildQuestionForm();
  }

  function buildQuestionForm() {
    const box = document.getElementById("questions");
    box.innerHTML = "";

    QUESTIONS.forEach((q, i) => {
      box.innerHTML += `
        <div class="question-box">
          <label>${i + 1}. ${q}</label>
          <span class="rank-label">1ìœ„ (2ì )</span>
          <input id="q${i}_1" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
          <span class="rank-label">2ìœ„ (1ì )</span>
          <input id="q${i}_2" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
        </div>
      `;
    });
  }

  /* --------------------------
      ì´ë¦„ ì •ê·œí™” (ì§€í›ˆ = ì´ì§€í›ˆ)
  --------------------------- */
  function normalizeName(name, existingNames) {
    if (!name) return "";

    name = name.trim().replace(/\s+/g, "");

    // í˜¸ì¹­ ì œê±°
    name = name.replace(/(ì´|ì•¼|ë‹˜|êµ°|ì–‘|ì”¨|ìš”)$/g, "");

    // ê¸°ì¡´ ì´ë¦„ê³¼ "í¬í•¨ ê´€ê³„" ìˆìœ¼ë©´ í†µì¼
    for (let saved of existingNames) {
      if (!saved) continue;
      if (saved.includes(name) || name.includes(saved)) {
        return saved;
      }
    }

    return name;
  }

  /* --------------------------
        íˆ¬í‘œ ì œì¶œ
  --------------------------- */
  async function submitVotes() {
    const dbRef = ref(db, "votes/");
    const snapshot = await get(dbRef);
    let data = snapshot.exists() ? snapshot.val() : {};

    // ê¸°ì¡´ ì´ë¦„ ìˆ˜ì§‘
    const existingNames = new Set();
    Object.values(data).forEach(qObj => {
      Object.keys(qObj).forEach(n => existingNames.add(n));
    });

    // ë°˜ì˜
    QUESTIONS.forEach((_, qi) => {
      if (!data[qi]) data[qi] = {};

      let raw1 = document.getElementById(`q${qi}_1`).value;
      let raw2 = document.getElementById(`q${qi}_2`).value;

      let first = normalizeName(raw1, existingNames);
      if (first) existingNames.add(first);

      let second = normalizeName(raw2, existingNames);
      if (second) existingNames.add(second);

      if (first && second && first === second) second = "";

      if (first) {
        if (!data[qi][first]) data[qi][first] = 0;
        data[qi][first] += 2;
      }
      if (second) {
        if (!data[qi][second]) data[qi][second] = 0;
        data[qi][second] += 1;
      }
    });

    const countRef = ref(db, "count");
    const countSnap = await get(countRef);
    const newCount = countSnap.exists() ? countSnap.val() + 1 : 1;

    await update(ref(db), {
      votes: data,
      count: newCount
    });

    alert("ì œì¶œ ì™„ë£Œ!");
    backToMode();
  }

  /* --------------------------
        ê´€ë¦¬ì ëª¨ë“œ
  --------------------------- */
  function showAdminLogin() {
    hideAll();
    document.getElementById("adminLogin").classList.remove("hidden");
  }

  function checkAdmin() {
    if (document.getElementById("adminPW").value === PASSWORD) {
      showAdmin();
    } else {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  }

  async function showAdmin() {
    hideAll();
    document.getElementById("adminPanel").classList.remove("hidden");

    const countSnap = await get(ref(db, "count"));
    document.getElementById("totalVotes").innerText =
      countSnap.exists() ? countSnap.val() : 0;

    buildGraphSelector();
    document.getElementById("resultBox").innerText = "ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.";
  }

  function buildGraphSelector() {
    const sel = document.getElementById("graphSelect");
    sel.innerHTML = "";
    QUESTIONS.forEach((q, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `${i + 1}. ${q}`;
      sel.appendChild(opt);
    });
  }

  async function showQuestionResult() {
    const idx = Number(document.getElementById("graphSelect").value);
    const snap = await get(ref(db, "votes/" + idx));
    const qData = snap.exists() ? snap.val() : {};

    const box = document.getElementById("resultBox");

    if (Object.keys(qData).length === 0) {
      box.innerText = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
      return;
    }

    const sorted = Object.entries(qData).sort((a, b) => b[1] - a[1]);

    let text = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\n`;
    sorted.forEach(([n, s], i) => (text += `${i + 1}ìœ„. ${n} : ${s}ì \n`));

    box.innerText = text;
  }

  async function showTotal() {
    const snap = await get(ref(db, "votes"));
    const data = snap.exists() ? snap.val() : {};
    const total = {};

    Object.values(data).forEach(qObj => {
      Object.entries(qObj).forEach(([name, score]) => {
        if (!total[name]) total[name] = 0;
        total[name] += score;
      });
    });

    const box = document.getElementById("resultBox");

    if (Object.keys(total).length === 0) {
      box.innerText = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const sorted = Object.entries(total).sort((a, b) => b[1] - a[1]);

    let text = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\n";
    sorted.forEach(([n, s], i) => (text += `${i + 1}ìœ„. ${n} : ${s}ì \n`));

    box.innerText = text;
  }

  async function resetAll() {
    if (!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await set(ref(db), null);
    alert("ì´ˆê¸°í™” ì™„ë£Œ!");
    showAdmin();
  }
</script>
</body>
</html>
